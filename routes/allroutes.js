let express=require("express"),router=express.Router(),diskdb=require("diskdb"),bcrypt=require("bcrypt");const saltRounds=10;diskdb.connect("DB",["loginDB"]);let fs=require("fs"),dir=require("node-dir"),expressValidator=require("express-validator");router.use(expressValidator());let authenticationMiddleware=require("./authentication.js").authenticationMiddleware;const db=require("./db.js");let ppa=__dirname;ppa=ppa.slice(0,-6),router.get("/",function(e,r){r.render("login",{msg:null})}),router.post("/login",function(e,r){userid=e.body.userid,password=e.body.password;let o=diskdb.loginDB.find({userid:userid});o.length>0?bcrypt.compare(password,o[0].password,(e,o)=>{o?(global.loged=!0,r.redirect("/home")):(global.loged=!1,r.render("login",{msg:"Incorrect UserId/Password"}))}):(global.loged=!1,r.render("login",{msg:"Incorrect UserId/Password"}))}),router.get("/sql",authenticationMiddleware(),function(e,r){r.render("sql",{sql:"",q:"",errors:"",out:""})}),router.post("/sql",function(e,r){let o=e.body.queries;db.all(o,function(e,t){r.render("sql",{sql:o,errors:e,out:t})})}),router.get("/register",authenticationMiddleware(),function(e,r){r.render("register",{title:"register",errors:null})}),router.post("/register",function(e,r){let o=e.body.userid,t=e.body.password;e.checkBody("userid","User Name is Requiered").notEmpty(),e.checkBody("password","Password is required").notEmpty(),e.checkBody("password2","Password is not matching").equals(e.body.password2);let s=e.validationErrors();s?(console.log(s),r.render("register",{errors:s})):bcrypt.hash(t,10,(e,t)=>{let s={userid:o,password:t};diskdb.loginDB.save(s),(s=db.loginDB.find({userid:o})).length>0?(global.loged=!1,console.log("registered"),r.redirect("/")):(console.log("Error in register registered"),r.redirect("/register"))})}),router.get("/home",authenticationMiddleware(),(e,r)=>{r.render("home",{title:"Home"})}),router.get("/upgrade",authenticationMiddleware(),(e,r)=>{r.render("upgrade",{title:"Upgrade"})}),router.get("/upgrade/post/:yr",function(e,r){let o=e.params.yr;db.all("select add_no from student where std=12",(e,r)=>{if(e)console.log(e);else{let e=r;for(let t=0;t<r.length;t++)db.all("select add_no,name,mob1,address,emis,img from student where add_no=?",[e[t].add_no],function(e,r){if(e)console.log(e);else for(let e=0;e<r.length;e++)console.log(r[e].add_no),db.all("insert into pastpeople values(?,?,?,?,?,?,?)",[r[e].add_no,r[e].name,o,r[e].mob1,r[e].address,r[e].emis,r[e].img],function(e){e&&console.log(e)})})}}),db.all("UPDATE student SET std=std+1 WHERE 1",e=>{e?r.send("ERROR in Upgrading student.."):db.all("DELETE FROM student WHERE std = 13",e=>{e?r.send("ERROR in Deleting student.."):r.render("upgrade",{msg:"Upgraded!",title:"Upgrade"})})})}),router.get("/past-people",authenticationMiddleware(),(e,r)=>{let o="nullpage";db.all("SELECT * FROM pastpeople",(e,t)=>{e?console.log(e):""===t?t="NO PAST PEOPLE FOUND":o="past-people",r.render(o,{title:"Past-People",list:t})})}),router.post("/past-people",(e,r)=>{let o="nullpage",t=e.body.year;console.log(t),db.all("SELECT * FROM pastpeople where year_passed=?",[t],(e,t)=>{e?console.log(e):""==t?t="NO PAST PEOPLE FOUND":o="past-people",r.render(o,{title:"Past-People",list:t})})}),router.get("/download",authenticationMiddleware(),function(e,r){global.disp=[],global.fname=[];let o=ppa+"public/pdf/";dir.files(o,function(e,o){if(e)console.log(e);else{let e=o;for(let r=0;r<e.length;r++){let o=e[r].length-4;".pdf"===e[r].slice(o)&&(disp.push(e[r]),fname.push(e[r].slice(-13)))}r.render("download",{title:"Download Report",fname:fname,src:disp})}})}),router.get("/download/:src",authenticationMiddleware(),function(e,r){let o=e.params.src,t="";for(let e=0;e<global.fname.length;e++)fname[e]===o&&(t=disp[e]);""!==t&&fs.unlink(t,function(e){e?console.log(e):r.redirect("/download")})}),router.get("/logout",(e,r)=>{global.loged=!1,r.redirect("/")}),module.exports=router;
