let express=require("express"),router=express.Router(),multer=require("multer"),fs=require("fs"),moment=require("moment"),authenticationMiddleware=require("./authentication.js").authenticationMiddleware;const db=require("./db.js");global.fn="";const storage=multer.diskStorage({destination:function(e,t,o){o(null,"./public/uploads/")},filename:function(e,t,o){global.fn=t.originalname,console.log(global.fn),o(null,global.fn)}}),upload=multer({storage:storage});router.get("/add",authenticationMiddleware(),function(e,t){t.render("add-student",{title:"Add Student"})}),router.post("/add",upload.any(),function(e,t){let o=e.body.sname.toUpperCase(),d=e.body.blood_group.toUpperCase(),a=e.body.exam_no.toUpperCase(),s=e.body.add_no.toUpperCase(),n=e.body.sstd.toUpperCase(),r=e.body.ssec.toUpperCase(),l=e.body.emis,i=e.body.aadhar,p=e.body.dob,u=e.body.gender.toUpperCase(),c=e.body.fname.toUpperCase(),m=e.body.foc.toUpperCase(),b=e.body.mname.toUpperCase(),f=e.body.moc.toUpperCase(),C=e.body.mob1,y=e.body.mob2,g=e.body.address.toUpperCase(),U=e.body.religion.toUpperCase(),E=e.body.caste.toUpperCase(),M=e.body.Community.toUpperCase(),h="./public/uploads/"+global.fn,R="./public/uploads/"+o+"-"+s+".jpg",S=o+"-"+s;fs.renameSync(h,R),db.all("insert into student values(?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)",[o,d,a,s,n,r,l,i,p,u,c,m,b,f,C,y,g,U,E,M,S],function(e){e?console.log(e):t.render("add-student",{msg:"Uploaded!",title:"Add Student"})})}),router.get("/show",authenticationMiddleware(),function(e,t){t.render("show-class",{title:"Class"})}),router.get("/edit/:std/:sec",authenticationMiddleware(),function(e,t){let o=e.params.std.toUpperCase(),d=e.params.sec.toUpperCase(),a=0,s=0,n=0,r=0,l=0,i=0,p=0,u=0,c=0,m=0,b=0,f=0,C=0,y=0,g="nullpage";db.all("select * from student where std =? and sec=? ORDER BY name",[o,d],function(e,U){if(e)console.log(e);else if(""==U)U="NO Student FOUND",t.render(g,{list:U,title:"Edit A Student",std:o,sec:d});else{for(let e in U)if(U.hasOwnProperty(e)){let t=U[e];t.dob=moment(t.dob,"YYYY-MM-DD").format("DD-MMM-YYYY").toUpperCase(),"SCA"===t.caste&&a++,"SC"===t.caste&&n++,"ST"===t.caste&&s++,"MBC"===t.caste&&r++,"BCM"===t.caste&&l++,"BC"===t.caste&&i++,"OC"===t.caste&&p++,"FC"===t.caste&&u++,"MALE"===t.gender&&m++,"FEMALE"===t.gender&&b++,"CHRISTIAN"===t.religion&&f++,"HINDU"===t.religion&&y++,"MUSLIM"===t.religion&&C++}db.all("select count(add_no) as total from student where std=?and sec=?",[o,d],function(e,E){if(e)console.log(e);else{let e=E[0].total;g="edit-student";let M={sca:a,st:s,sc:n,mbc:r,bcm:l,bc:i,oc:p,fc:u,others:c=e-(a+s+n+r+l+i+p+u+c),male:m,female:b,christian:f,muslim:C,hindu:y};t.render(g,{listoff:M,list:U,title:"Edit A Student",std:o,sec:d,total:e})}})}})}),router.get("/modify/:add/:sname",authenticationMiddleware(),function(e,t){let o=e.params.add,d=e.params.sname.trim();db.all("SELECT * FROM `student` WHERE `add_no`= ? and name = ?",[o,d],function(e,o){e?console.log(e):t.render("editspecial",{title:"Edit Student",list:o[0]})})}),router.post("/update/:addno",function(e,t){let o=e.params.addno,d=e.body.sname.toUpperCase(),a=e.body.blood_group.toUpperCase(),s=e.body.exam_no.toUpperCase(),n=e.body.add_no.toUpperCase(),r=e.body.sstd.toUpperCase(),l=e.body.ssec.toUpperCase(),i=e.body.emis,p=e.body.aadhar,u=e.body.dob,c=e.body.gender.toUpperCase(),m=e.body.fname.toUpperCase(),b=e.body.foc.toUpperCase(),f=e.body.mname.toUpperCase(),C=e.body.moc.toUpperCase(),y=e.body.mob1,g=e.body.mob2,U=e.body.address.toUpperCase(),E=e.body.religion.toUpperCase(),M=e.body.caste.toUpperCase(),h=e.body.Community.toUpperCase(),R=d+"-"+n;db.all("SELECT * FROM `student` WHERE `add_no`= ?",[o],function(e,S){if(e)console.log(e);else{let e="./public/uploads/"+(S[0].name+"-"+S[0].add_no)+".jpg",w="./public/uploads/"+d+"-"+n+".jpg";fs.rename(e,w,function(e){e&&console.log("ERROR: "+e)}),db.all("UPDATE student SET name=?,bg=?,exno=?,add_no=?,std=?,sec=?,emis=?,aadhar=?,dob=?,gender=?,fname=?,foc=?,mname=?,moc=?,mob1=?,mob2=?,address=?,religion=?,caste=?,community=?,img=? WHERE add_no = ? ",[d,a,s,n,r,l,i,p,u,c,m,b,f,C,y,g,U,E,M,h,R,o],function(e,o){e?console.log(e):t.redirect("/students/edit/"+r+"/"+l)})}})}),router.get("/delete/:add_no/:sname",authenticationMiddleware(),function(e,t){let o=e.params.add_no,d=e.params.sname;db.all("DELETE FROM `student` WHERE `add_no` = ? AND `name` = ?",[o,d],function(e){if(e)t.send("ERROR in Deleting student..");else{let e="./public/uploads/"+d+"-"+o+".jpg";fs.unlinkSync(e),t.redirect("/students/show")}})}),router.get("/atnd-report/:std/:sec",authenticationMiddleware(),function(e,t){let o=e.params.std.toUpperCase(),d=e.params.sec.toUpperCase();t.render("atnd-report",{sec:d,std:o})}),router.get("/report/:std/:sec",authenticationMiddleware(),function(e,t){let o=e.params.std.toUpperCase(),d=e.params.sec.toUpperCase();t.render("student-report",{sec:d,std:o})}),module.exports=router;