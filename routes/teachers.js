let express=require("express"),router=express.Router(),multer=require("multer"),fs=require("fs"),authenticationMiddleware=require("./authentication.js").authenticationMiddleware;const db=require("./db.js");global.fn="";const storage=multer.diskStorage({destination:function(e,t,o){o(null,"./public/uploads/")},filename:function(e,t,o){global.fn=t.originalname,console.log(global.fn),o(null,global.fn)}}),upload=multer({storage:storage});router.get("/add",authenticationMiddleware(),function(e,t){t.render("add-teach",{title:"Add A Teacher"})}),router.post("/add",upload.any(),function(e,t){let o=e.body.tid,l=e.body.tname.toUpperCase(),n=e.body.tstd,a=e.body.tsec.toUpperCase(),d=e.body.tphno,r="./public/uploads/"+global.fn,i="./public/uploads/"+l+"-"+o+".jpg",c=l+"-"+o;fs.renameSync(r,i),db.all("insert into teacher values(?,?,?,?,?,?)",[o,l,n,a,d,c],function(e){e?console.log(e):t.render("add-teach",{title:"Add A Teacher",msg:"Uploaded"})})}),router.get("/edit",authenticationMiddleware(),function(e,t){let o="nullpage";db.all("SELECT * FROM teacher ORDER BY std ASC",function(e,l){e?console.log(e):""==l?l="NO TEACHER FOUND":o="edit-teacher",t.render(o,{title:"Edit A Teacher",list:l})})}),router.get("/edit/:id/:name",authenticationMiddleware(),function(e,t){let o=e.params.id;db.all("SELECT * FROM teacher where tid = ?",[o],function(e,o){e?console.log(e):t.render("editspecialteach",{title:"Edit A Teacher",list:o[0]})})}),router.post("/class-teacher",function(e,t){let o=e.body.tsec.toUpperCase(),l=e.body.tstd.toUpperCase(),n=e.body.teach;console.log(o+"\n"+l+"\n"+n+"\n"),"all"===n?db.all("update teacher set std=?,sec=? where 1",[l,o],function(e){e?console.log(e):t.redirect("/teachers/edit")}):db.all("update teacher set std=?,sec=? where tid=?",[l,o,n],function(e){e?console.log(e):t.redirect("/teachers/edit")})}),router.post("/update/:oldid",function(e,t){let o=e.params.oldid,l=e.body.tid,n=e.body.tname.toUpperCase().trim(),a=e.body.tstd,d=e.body.tsec,r=e.body.tphno,i=n+"-"+l;db.all("SELECT * FROM teacher where tid = ?",[o],function(e,c){if(e)console.log(e);else{let e="./public/uploads/"+(c[0].name+"-"+c[0].tid)+".jpg",s="./public/uploads/"+n+"-"+l+".jpg";console.log("\nloc:\t"+e),console.log("\nnew loc:\t"+s),fs.rename(e,s,function(e){e&&console.log("ERROR: "+e)}),db.all("UPDATE teacher SET tid = ?,name = ?,std = ?,sec = ?,phno = ?,img = ?  WHERE tid = ? ",[l,n,a,d,r,i,o],function(e,o){e?console.log(e):t.redirect("/teachers/edit")})}})}),router.get("/delete/:tid/:tname",authenticationMiddleware(),function(e,t){let o=e.params.tid,l=e.params.tname,n="./public/uploads/"+l+"-"+o+".jpg";fs.unlinkSync(n),db.all("DELETE FROM teacher WHERE tid = ? AND name = ?",[o,l],function(e,o){e?t.send("ERROR in Deleting Teacher.."):t.redirect("/teachers/edit")})}),module.exports=router;