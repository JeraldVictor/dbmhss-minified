let express=require("express"),router=express.Router(),Pagination=require("./pagination");const db=require("./db.js");let std,sec,puppeteer=require("puppeteer"),merge=require("easy-pdf-merge"),fs=require("fs"),moment=require("moment"),datesBetween=require("dates-between"),authenticationMiddleware=require("./authentication.js").authenticationMiddleware,ppa=__dirname;ppa=ppa.slice(0,-6);let year,next_yr,pdfUrls=[],names=[],files2gather=[],ppage=0;router.get("/year/:yr/:std/:sec/:page",authenticationMiddleware(),(e,t)=>{let a=e.params.std,r=e.params.sec,s=e.params.page;year=e.params.yr,next_yr=parseInt(year)+1,t.redirect("/report/"+a+"/"+r+"/"+s)}),router.get("/:std/:sec/:page",authenticationMiddleware(),(e,t)=>{std=e.params.std.toUpperCase(),sec=e.params.sec.toUpperCase();let a=e.params.page,r=0,s=0,n=0,o=0,p=0,l=0,c=0,d=0,i=0,u=0,g=0,m=0,f=0,h=0;page_id=parseInt(e.params.page),currentPage=page_id>0?page_id:currentPage,pageUri="/report/"+std+"/"+sec+"/",db.all("SELECT COUNT(add_no) as totalCount FROM student where std=? and sec=?",[std,sec],function(e,w){let y=w[0].totalCount,b=new Pagination(y,currentPage,pageUri,5),C="not ok";C=b.pageCount===parseInt(a)?"ok":"not ok",ppage=b.pageCount,db.all("SELECT * FROM student where std=? and sec=? LIMIT "+b.perPage+" OFFSET "+b.offset,[std,sec],function(e,a){e&&console.log("err :\n"+e);for(let e in a)if(a.hasOwnProperty(e)){let t=a[e];t.dob=moment(t.dob,"YYYY-MM-DD").format("DD-MMM-YYYY").toUpperCase(),"SCA"===t.caste&&r++,"SC"===t.caste&&n++,"ST"===t.caste&&s++,"MBC"===t.caste&&o++,"BCM"===t.caste&&p++,"BC"===t.caste&&l++,"OC"===t.caste&&c++,"FC"===t.caste&&d++,"MALE"===t.gender&&u++,"FEMALE"===t.gender&&g++,"CHRISTIAN"===t.religion&&m++,"HINDU"===t.religion&&h++,"MUSLIM"===t.religion&&f++}let w=r+s+n+o+p+l+c+d+i;i=b.totalCount-w,data={items:a,pages:b.links(),pageCount:b.pageCount,last:C,year:year,std:std,sec:sec,start:b.offset,sca:r,st:s,sc:n,mbc:o,bcm:p,bc:l,oc:c,fc:d,others:i,male:u,female:g,christian:m,muslim:f,hindu:h},t.render("STUDENTSPARTICULARS",data)})})}),router.get("/print/:count/:std/:sec",authenticationMiddleware(),(e,t)=>{let a;if(std=e.params.std.toUpperCase(),sec=e.params.sec.toUpperCase(),count=e.params.count,count>=1){a="/report/daily1/"+std+"/"+sec+"/1/page1/1",files2gather.push(ppa+"public/pdf/final.pdf");let e="http://localhost/report/"+std+"/"+sec+"/1";pdfUrls.push(e);let r=ppa+"public/pdf/final";names.push(r+".pdf"),async function(){let e=await puppeteer.launch(),r=await e.newPage();r.on("error",e=>{throw console.log("error happen at the page: ",e),e});for(let e=0;e<pdfUrls.length;e++){await r.goto(pdfUrls[e],{waitUntil:"networkidle2"});let t=ppa+"public/pdf/final.pdf";await r.pdf({path:t,format:"legal"})}await e.close(),await t.redirect(a)}()}else{a="/report/mergefile";for(let e=0;e<ppage;e++){let r="http://localhost/report/"+std+"/"+sec+"/"+(e+1);pdfUrls.push(r);let s=ppa+"public/pdf/sample";names.push(s+e+".pdf"),(async()=>{let e=await puppeteer.launch(),r=await e.newPage();for(let e=0;e<pdfUrls.length;e++){await r.goto(pdfUrls[e],{waitUntil:"networkidle2"});let t=ppa+"public/pdf/sample"+e+".pdf";await r.pdf({path:t,format:"legal"})}await e.close(),await t.redirect(a)})()}}}),router.get("/mergefile",authenticationMiddleware(),(e,t)=>{merge(names,ppa+"public/pdf/final.pdf",function(e){if(e)return console.log(e);console.log("Success");for(let e=0;e<pdfUrls.length;e++)fs.unlink(names[e],function(e){e&&console.log(e)});files2gather.push(ppa+"public/pdf/final.pdf"),t.redirect("/report/daily1/"+std+"/"+sec+"/1/page1/1")})});let currentmonth="";function gendate(e,t){let a,r;switch(e){case 1:a=new Date(t+"-06-01"),r=new Date(t+"-06-30");break;case 2:a=new Date(t+"-07-01"),r=new Date(t+"-07-31");break;case 3:a=new Date(t+"-08-01"),r=new Date(t+"-08-31");break;case 4:a=new Date(t+"-09-01"),r=new Date(t+"-09-30");break;case 5:a=new Date(t+"-10-01"),r=new Date(t+"-10-31");break;case 6:a=new Date(t+"-11-01"),r=new Date(t+"-11-30");break;case 7:a=new Date(t+"-12-01"),r=new Date(t+"-12-31");break;case 8:a=new Date(t+"-01-01"),r=new Date(t+"-01-31");break;case 9:a=new Date(t+"-02-01"),r=new Date(t+"-02-28");break;case 10:a=new Date(t+"-03-01"),r=new Date(t+"-03-31");break;case 11:a=new Date(t+"-04-01"),r=new Date(t+"-04-30")}return str=[],sun=[],Array.from(datesBetween(a,r))}router.get("/daily1/:std/:sec/:mon/page1/:count",authenticationMiddleware(),(e,t)=>{std=e.params.std.toUpperCase(),sec=e.params.sec.toUpperCase();let a=e.params.mon,r=e.params.count;switch(parseInt(a)){case 1:currentmonth="JUNE";break;case 2:currentmonth="JULY";break;case 3:currentmonth="AUGUST";break;case 4:currentmonth="SEPTEMBER";break;case 5:currentmonth="OCTOBER";break;case 6:currentmonth="NOVEMBER";break;case 7:currentmonth="DECEMBER";break;case 8:year=next_yr,currentmonth="JANUARY";break;case 9:year=next_yr,currentmonth="FEBRUARY";break;case 10:year=next_yr,currentmonth="MARCH";break;case 11:year=next_yr,currentmonth="APRIL"}page_id=parseInt(e.params.count),currentPage=page_id>0?page_id:currentPage,pageUri="/report/daily1/"+std+"/"+sec+"/"+a+"/page1/",db.all("SELECT COUNT(add_no) as totalCount FROM student where std=? and sec=?",[std,sec],(e,s)=>{let n=s[0].totalCount,o=new Pagination(n,currentPage,pageUri,30);ppage=Pagination.pageCount;let p="not ok";p=o.pageCount===parseInt(r)?"ok":"not ok",db.all("SELECT * FROM student where std=? and sec=? LIMIT "+o.perPage+" OFFSET "+o.offset,[std,sec],function(e,r){if(e)console.log("err :\n"+e);else{str=[];let e=gendate(parseInt(a),year);for(let t=0;t<e.length;t++)str[t]=moment(e[t]).format("DD-MMM-YYYY-ddd"),"Sun"===moment(e[t]).format("ddd")&&(sun[t]=moment(e[t]).format("DD-MMM-YYYY"));let s=[];for(let e=0;e<15;e++)str[e].match("Sun")?s.push("Sun"):s.push("a");data={items:r,pages:o.links(),pageCount:o.pageCount,month:currentmonth,year:year,std:std,sec:sec,start:o.offset},t.render("daily-right",{data:data,start:str.length,days:s,last:p})}})})}),router.get("/daily2/:std/:sec/:mon/page2/:count",function(e,t){std=e.params.std.toUpperCase(),sec=e.params.sec.toUpperCase(),c=e.params.mon;let a=e.params.count;switch(parseInt(c)){case 1:currentmonth="JUNE";break;case 2:currentmonth="JULY";break;case 3:currentmonth="AUGUST";break;case 4:currentmonth="SEPTEMBER";break;case 5:currentmonth="OCTOBER";break;case 6:currentmonth="NOVEMBER";break;case 7:currentmonth="DECEMBER";break;case 8:year=next_yr,currentmonth="JANUARY";break;case 9:year=next_yr,currentmonth="FEBRUARY";break;case 10:year=next_yr,currentmonth="MARCH";break;case 11:year=next_yr,currentmonth="APRIL"}page_id=parseInt(e.params.count),currentPage=page_id>0?page_id:currentPage,pageUri="/report/daily2/"+std+"/"+sec+"/"+c+"/page2/",db.all("SELECT COUNT(add_no) as totalCount FROM student where std=? and sec=?",[std,sec],(e,r)=>{let s=r[0].totalCount,n=new Pagination(s,currentPage,pageUri,30);ppage=Pagination.pageCount;let o="not ok";o=n.pageCount===parseInt(a)?"ok":"not ok",db.all("SELECT * FROM student where std=? and sec=? LIMIT "+n.perPage+" OFFSET "+n.offset,[std,sec],function(e,a){if(e)console.log("err :\n"+e);else{let e=gendate(parseInt(c),year);str=[];for(let t=0;t<e.length;t++)str[t]=moment(e[t]).format("DD-MMM-YYYY-ddd"),"Sun"==moment(e[t]).format("ddd")&&(sun[t]=moment(e[t]).format("DD-MMM-YYYY"));if(moment([year]).isLeapYear()&&moment(year+"-02-29").isValid()){let e=moment(year+"-02-29").format("DD-MMM-YYYY-ddd");str.push(e)}if(2===c&&moment([year]).isLeapYear()&&moment(year+"-02-29").isValid()){let e=moment(year+"-02-29").format("DD-MMM-YYYY-ddd");str.push(e)}let r=[];for(let e=15;e<str.length;e++)str[e].match("Sun")?r.push("Sun"):r.push("a");data={items:a,pages:n.links(),pageCount:n.pageCount,month:currentmonth,year:year,std:std,sec:sec,start:n.offset},t.render("daily-left",{data:data,start:str.length,days:r,last:o})}})})}),router.get("/daily/print/daily/:totalpage",authenticationMiddleware(),(e,t)=>{pdfUrls=[],names=[];let a=e.params.totalpage;for(let e=1;e<12;e++)for(let t=0;t<a;t++)for(let a=1;a<=2;a++){let r="http://localhost/report/daily"+a+"/"+std+"/"+sec+"/"+e+"/page"+a+"/"+(t+1);pdfUrls.push(r)}for(let e=0;e<pdfUrls.length;e++){let t=ppa+"public/pdf/dayssample";names.push(t+e+".pdf")}!async function(){let e=await puppeteer.launch(),a=await e.newPage();for(let e=0;e<pdfUrls.length;e++){await a.goto(pdfUrls[e],{waitUntil:"networkidle2"});let t="dayssample"+e+".pdf";await a.pdf({path:ppa+"public/pdf/"+t,format:"legal"})}await e.close(),await t.redirect("/report/mergefile/days/"+std+"/"+sec)}()}),router.get("/mergefile/days/:std/:sec",authenticationMiddleware(),(e,t)=>{std=e.params.std.toUpperCase(),sec=e.params.sec.toUpperCase(),merge(names,ppa+"public/pdf/daysfinal.pdf",function(e){if(e)return console.log(e);console.log("Success");for(let e=0;e<pdfUrls.length;e++)fs.unlink(names[e],function(e){e&&console.log(e)});files2gather.push(ppa+"public/pdf/daysfinal.pdf"),t.redirect("/report/merge/finished-a-class/"+std+"/"+sec)})}),router.get("/merge/finished-a-class/:std/:sec",authenticationMiddleware(),(e,t)=>{std=e.params.std.toUpperCase(),sec=e.params.sec.toUpperCase();let a=ppa+"public/pdf/"+std+"-"+sec+"-"+(year-=1)+".pdf";console.log(files2gather),merge(files2gather,a,function(e){if(e)return console.log(e);console.log("Success");for(let e=0;e<files2gather.length;e++)fs.unlink(files2gather[e],function(e){e&&console.log(e)});t.redirect("/download")})}),module.exports=router;
